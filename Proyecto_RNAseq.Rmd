---
title: "Proyecto_RNAseq"
author: "Karla Ximena González Platas"
date: "2025-02-05"
output:
  pdf_document:
    toc: true
    toc_depth: 2
    highlight: tango
    keep_tex: true
  html_document:
    toc: true
    toc_depth: '2'
    df_print: paged
subtitle: Análisis de Expresión Diferencial
---

## Introducción 
El conjunto de datos analizado en este proyecto se deriva del estudio de Muluhngwi y Klinge (2021), que explora las interacciones regulatorias entre los miembros de la familia miR-29 y los lncRNAs (ARN largos no codificantes) en el contexto de la resistencia a la terapia endocrina. En este estudio, se aplicó el análisis de RNA-seq para investigar la expresión de lncRNAs regulados por miR-29b-1-3p y miR-29a-3p en células de cáncer de mama sensibles a la terapia endocrina (MCF-7) y resistentes a la terapia endocrina (LCC9). Estas líneas celulares fueron empleadas para estudiar los efectos de la regulación de lncRNAs por los miR-29b-1-3p y miR-29a-3p en la progresión del cáncer de mama y la resistencia endocrina. Para ello, se realizaron transfecciones en las células MCF-7 y LCC9 con pre-miR-29b-1-3p y pre-miR-29a-3p para evaluar los efectos de su sobreexpresión, mientras que el uso de anti-miR-29 y un control negativo permitió analizar la inhibición de estos miRNAs. Asimismo, se llevaron a cabo co-transfecciones combinando pre-miR-29b-1-3p o pre-miR-29a-3p con anti-miR-29 para examinar posibles efectos compensatorios en la regulación de los lncRNAs.

## Instalación y carga de paquetes

```{r message=FALSE, warning=FALSE}

# Instalar BiocManager si no está instalado
#if (!requireNamespace("BiocManager", quietly = TRUE)) {
#    install.packages("BiocManager")
#}

# Instalar paquetes de Bioconductor
#BiocManager::install(
#    c(
#        "edgeR", 
#        "ExploreModelMatrix",
#        "limma",
#        "recount3"
#    )
#)

# Instalar paquetes de CRAN
#install.packages(c(
#    "pheatmap", 
#    "patchwork",
#    "RColorBrewer",
#    "cowplot"
#))

## Cargar los paquetes
library("recount3")
library("limma")
library("edgeR")
library("ExploreModelMatrix")
library("cowplot")
library("RColorBrewer")
library("pheatmap")

```

## Selección de Proyecto

```{r}

# Obtener la lista de proyectos disponibles 
human_projects <- available_projects()

# Ver los proyectos disponibles
dim(human_projects)

# Esto nos indica cuántos proyectos están disponibles (número de filas) 
# y cuántas columnas de información se proporcionan para cada proyecto.

# Mostrar las primeras filas para inspeccionar su estructura y contenido
head(human_projects)

# Seleccionar un estudio de interés
human_projects[709, ]

# Filtrar el dataframe para seleccionar un proyecto específico basado en su ID y tipo
project_info <- subset(
  human_projects,
  project == "SRP075398" & project_type == "data_sources"
)

# Mostrar la información del proyecto seleccionado para confirmar que se ha
# filtrado correctamente
project_info

```

```{r}

# Crear un objeto de tipo RangedSummarizedExperiment (RSE) con la información a nivel de genes
rse_gene_SRP075398 <- create_rse(project_info)

# Explorar el objeto RSE
rse_gene_SRP075398

## Información sobre el RSE creado
metadata(rse_gene_SRP075398)

## Número de genes y número de muestras
dim(rse_gene_SRP075398)

```

El estudio **SRP075398** se compuso de **18 muestras**, para las cuales tenemos **63,856 genes** en GENCODE v26.
La información específica de la anotación está disponible rowRanges() como se muestra a continuación con la columna gene_id utilizada para identificar genes en cada una de las anotaciones.

```{r}
# Información sobre los genes
rowRanges(rse_gene_SRP075398)
```


## Preparación de los datos 

```{r}

# Convertir las cuentas por nucleotido a cuentas por lectura usando compute_read_counts().
assay(rse_gene_SRP075398, "counts") <- compute_read_counts(rse_gene_SRP075398)

# Inspeccionar la información experimental de cada muestra
rse_gene_SRP075398$sra.sample_attributes[]

# Expandir los atributos en columnas separadas para facilitar su uso
rse_gene_SRP075398 <- expand_sra_attributes(rse_gene_SRP075398)

# Extraer y mostrar las columnas que contienen atributos 
colData(rse_gene_SRP075398)[
  ,
  grepl("^sra_attribute", colnames(colData(rse_gene_SRP075398)))
]

```

```{r}

# Ajustar el tipo de dato de las variables categóricas 

rse_gene_SRP075398$sra_attribute.cell_line <- factor(rse_gene_SRP075398$sra_attribute.cell_line)

rse_gene_SRP075398$sra_attribute.source_name <- factor(tolower(rse_gene_SRP075398$sra_attribute.source_name))

rse_gene_SRP075398$sra_attribute.transfection <- factor(rse_gene_SRP075398$sra_attribute.transfection)

# Resumen estadístico de las variables seleccionadas
summary(as.data.frame(colData(rse_gene_SRP075398)[
    ,
    grepl("^sra_attribute.[cell_line|source_name|transfection]", colnames(colData(rse_gene_SRP075398)))
]))

```

```{r}

# Calcular la proporción de lecturas asignadas a genes para evaluar la calidad de las muestras
rse_gene_SRP075398$assigned_gene_prop <- 
  rse_gene_SRP075398$recount_qc.gene_fc_count_all.assigned / 
  rse_gene_SRP075398$recount_qc.gene_fc_count_all.total

# Resumen de la nueva variable para identificar si las muestras tienen una asignación adecuada de lecturas (valores cercanos a 1 son indicadores de buena calidad)

summary(rse_gene_SRP075398$assigned_gene_prop)

```

## Filtrar genes de baja expresión

```{r}
# Guardar el objeto original
rse_gene_SRP075398_unfiltered <- rse_gene_SRP075398

# Visualizar la distribución de la proporción de lecturas asignadas a genes en cada muestra

hist(rse_gene_SRP075398$assigned_gene_prop, 
     main = "Proporción de lecturas asignadas a genes", 
     xlab = "Proporción asignada", col = "lightblue")

# Verificar si existen muestras de baja calidad antes del filtrado
table(rse_gene_SRP075398$assigned_gene_prop < 0.3)

# Filtrar las muestras con proporción de lecturas asignadas superior a 0.3
rse_gene_SRP075398 <- rse_gene_SRP075398[, rse_gene_SRP075398$assigned_gene_prop > 0.3]

# Crear un objeto DGEList, para el análisis diferencial usando edgeR
dge <- DGEList(counts = assay(rse_gene_SRP075398, "counts"))

# Filtrar genes de baja expresión considerando combinaciones de transfección y línea celular
keep <- filterByExpr(dge, group = interaction(
  rse_gene_SRP075398$sra_attribute.transfection, 
  rse_gene_SRP075398$sra_attribute.cell_line
))
rse_gene_SRP075398 <- rse_gene_SRP075398[keep, ]

# Dimensiones finales
dim(rse_gene_SRP075398)

# Porcentaje de genes retenidos
round(nrow(rse_gene_SRP075398) / nrow(rse_gene_SRP075398_unfiltered) * 100, 2)

```

Se descartó los genes de baja expresión porque no contribuyen significativamente a las conclusiones biológicas. De modo que, después del filtrado se obtuvieron 23741 lo cual representa el 37.18% de genes retenidos. 

## Normalización de los datos

```{r}

# Crear un objeto DGEList para normalización
dge <- DGEList(
    counts = assay(rse_gene_SRP075398, "counts"),
    genes = rowData(rse_gene_SRP075398)
)

# Normalización TMM
dge <- calcNormFactors(dge)

dge

```


## Determinar el modelo estadístico

```{r}

# Construcción de la matriz de diseño para el modelo lineal.
mod <- model.matrix(
  ~ sra_attribute.cell_line + sra_attribute.transfection + assigned_gene_prop,
  data = colData(rse_gene_SRP075398)
)

# Cada columna representa un coeficiente del modelo
colnames(mod)

# Visualizar la matriz de diseño completa
# Las filas representan muestras, mientras que las columnas son las variables del modelo
mod

```

Este modelo incluye:
- sra_attribute.cell_line: Efecto del tipo de línea celular (LCC9 o MCF-7).
- sra_attribute.transfection: Efecto del tratamiento por transfección (pre-miR-29a, pre-miR-29b-1, Anti-miR-29a).
- assigned_gene_prop: Proporción de lecturas asignadas a genes

## Visualizar matriz

```{r}

## Crear las visualizaciones
vd <- ExploreModelMatrix::VisualizeDesign(
    sampleData = colData(rse_gene_SRP075398), # Metadatos de las muestras
    designFormula = ~ sra_attribute.cell_line + sra_attribute.transfection,   
    textSizeFitted = 2
)

cowplot::plot_grid(plotlist = vd$plotlist)

```

## Expresión diferencial

```{r}

# Convertir los datos de conteo a valores log2 y ajusta las varianzas para hacerlos aptos para un análisis lineal 

vGene <- voom(dge, mod, plot = TRUE)

# Ajuste del modelo lineal y cálculo de estadísticas empíricas de Bayes
eb_results <- eBayes(lmFit(vGene))


# Extraer la tabla de genes diferencialmente expresados.
de_results <- topTable(
    eb_results,
    coef = 2, # Se refiere al coeficiente del segundo término en el modelo
    number = nrow(rse_gene_SRP075398),
    sort.by = "none"
)

# Dimensiones y vista preliminar de los resultados
dim(de_results)

head(de_results)

```
```{r}

# Genes diferencialmente expresados con FDR < 5%
table(de_results$adj.P.Val < 0.05)

# Visualizar los resultados estadísticos

plotMA(eb_results, coef = 2)

volcanoplot(eb_results, coef = 2, highlight = 3, names = de_results$gene_name)

# Información de los 3 genes más significativos 
de_results[de_results$gene_name %in% c("AMIGO2", "AFAP1L2", "PHLDA1"), ]

```

## Visualizar genes DE

```{r}

# Revisar los top 50 genes diferencialmente expresados

# Extraer valores de los genes de interés
exprs_heatmap <- vGene$E[rank(de_results$adj.P.Val) <= 50, ]

# Crear una tabla con información de las muestras y con nombres de columnas más amigables
df <- as.data.frame(colData(rse_gene_SRP075398)[, c("sra_attribute.cell_line", "sra_attribute.transfection")])
colnames(df) <- c("Cell_line", "Transfection")

# Hacer un heatmap
pheatmap(
    exprs_heatmap,
    cluster_rows = TRUE,
    cluster_cols = TRUE,
    show_rownames = FALSE,
    show_colnames = FALSE,
    annotation_col = df
)

```

```{r}

# MDS (multidimensional scaling)

## Convertir los grupos de Cell_line a colores
col.group <- df$Cell_line
levels(col.group) <- brewer.pal(nlevels(col.group), "Set2")
col.group <- as.character(col.group)

## MDS por grupos de Cell_line
plotMDS(vGene$E, labels = df$Cell_line, col = col.group)
```


```{r}

## Convertir Transfection a colores
col.group <- df$Transfection
df$Transfection <- as.factor(df$Transfection) # Asegúrate de que sea un factor
colors <- brewer.pal(nlevels(df$Transfection), "Set2") # Generar paleta de colores
levels(col.group) <- colors # Asignar colores a los niveles
col.group <- as.character(col.group) # Convertir a vector de caracteres

## MDS por grupos de Transfection
plotMDS(vGene$E, labels = df$Transfection, col = col.group, 
        main = "MDS Plot by Transfection", pch = 16)

## Agregar leyenda
legend("topright", legend = levels(df$Transfection), fill = unique(col.group),
       title = "Transfection Groups")
```










