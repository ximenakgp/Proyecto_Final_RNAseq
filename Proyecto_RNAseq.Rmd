---
title: "Proyecto_RNAseq"
author: "Karla Ximena González Platas"
date: "2025-02-05"
output:
  html_document:
    toc: true
    toc_depth: '2'
    df_print: paged
  pdf_document:
    toc: true
    toc_depth: 2
    highlight: tango
    keep_tex: true
subtitle: Análisis de Expresión Diferencial
---

## Introducción 

## Instalar y cargas paquetes

```{r message=FALSE, warning=FALSE}

# Cargar el paquete de R que incluye a SummarizedExperiment y todas las demás dependencias
library("recount3")
library(limma)
library(edgeR)

```


## Selección de Proyecto

```{r}

# Obtener la lista de proyectos disponibles 
human_projects <- available_projects()

# Ver los proyectos disponibles
dim(human_projects)


# Mostrar las primeras filas para inspeccionar su estructura y contenido
head(human_projects)

# Seleccionar un estudio de interés
human_projects[709, ]

# Filtrar el dataframe para seleccionar un proyecto específico basado en su ID y tipo
project_info <- subset(
  human_projects,
  project == "SRP075398" & project_type == "data_sources"
)

# Mostrar la información del proyecto seleccionado para confirmar que se ha filtrado correctamente
project_info

```

```{r}

# Crear un objeto de tipo RangedSummarizedExperiment (RSE) con la información a nivel de genes
rse_gene_SRP075398 <- create_rse(project_info)

# Explorar el objeto RSE
rse_gene_SRP075398

## Información sobre el RSE creado
metadata(rse_gene_SRP075398)

## Número de genes y número de muestras
dim(rse_gene_SRP075398)

```

El estudio **SRP068565** se compuso de **20 muestras**, para las cuales tenemos **63,856 genes** en GENCODE v26.
La información específica de la anotación está disponible rowRanges() como se muestra a continuación con la columna gene_id utilizada para identificar genes en cada una de las anotaciones.

```{r}

# Información sobre los genes
rowRanges(rse_gene_SRP075398)
```


## Preparación de los datos 

```{r}

# Convertir las cuentas por nucleotido a cuentas por lectura usando compute_read_counts().
assay(rse_gene_SRP075398, "counts") <- compute_read_counts(rse_gene_SRP075398)

rse_gene_SRP075398$sra.sample_attributes[]

# Hacer más fácil de usar la información del experimento
rse_gene_SRP075398 <- expand_sra_attributes(rse_gene_SRP075398)

colData(rse_gene_SRP075398)[
  ,
  grepl("^sra_attribute", colnames(colData(rse_gene_SRP075398)))
]


colnames(colData(rse_gene_SRP075398))

```

```{r}

# Ajustar el tipo de dato de las variables
## Pasar de character a factor

rse_gene_SRP075398$sra_attribute.cell_line <- factor(rse_gene_SRP075398$sra_attribute.cell_line)

rse_gene_SRP075398$sra_attribute.source_name <- factor(tolower(rse_gene_SRP075398$sra_attribute.source_name))

rse_gene_SRP075398$sra_attribute.transfection <- factor(rse_gene_SRP075398$sra_attribute.transfection)

# Resumen de las variables
summary(as.data.frame(colData(rse_gene_SRP075398)[
    ,
    grepl("^sra_attribute.[cell_line|source_name|transfection]", colnames(colData(rse_gene_SRP075398)))
]))

```

```{r}
# Calcular la proporción de lecturas asignadas a genes
rse_gene_SRP075398$assigned_gene_prop <- 
  rse_gene_SRP075398$recount_qc.gene_fc_count_all.assigned / 
  rse_gene_SRP075398$recount_qc.gene_fc_count_all.total

# Resumen de la nueva variable
summary(rse_gene_SRP075398$assigned_gene_prop)


```

## Filtrar genes de baja expresión

```{r}
# Guardar el objeto original
rse_gene_SRP075398_unfiltered <- rse_gene_SRP075398

# Filtrar muestras de baja calidad
hist(rse_gene_SRP075398$assigned_gene_prop)
table(rse_gene_SRP075398$assigned_gene_prop < 0.3)
rse_gene_SRP075398 <- rse_gene_SRP075398[, rse_gene_SRP075398$assigned_gene_prop > 0.3]

# Filtrar genes de baja expresión usando edgeR
dge <- DGEList(counts = assay(rse_gene_SRP075398, "counts"))
keep <- filterByExpr(dge, group = rse_gene_SRP075398$sra_attribute.transfection)
rse_gene_SRP075398 <- rse_gene_SRP075398[keep, ]

# Dimensiones finales
dim(rse_gene_SRP075398)

# Porcentaje de genes retenidos
round(nrow(rse_gene_SRP075398) / nrow(rse_gene_SRP075398_unfiltered) * 100, 2)
```


## Normalización de los datos

```{r}
# Crear un objeto DGEList para normalización
dge <- DGEList(counts = assay(rse_gene_SRP075398, "counts"))

# Normalización TMM
dge <- calcNormFactors(dge)

```


## Determinar el modelo estadístico

```{r}

# Crear la matriz de diseño
design <- model.matrix(
  ~ sra_attribute.cell_line * sra_attribute.transfection,
  data = colData(rse_gene_SRP075398)
)

```







