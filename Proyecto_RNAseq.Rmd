---
title: "Proyecto_RNAseq"
author: "Karla Ximena González Platas"
date: "2025-02-05"
output:
  pdf_document:
    toc: true
    toc_depth: 2
    highlight: tango
    keep_tex: true
  html_document:
    toc: true
    toc_depth: '2'
    df_print: paged
subtitle: Análisis de Expresión Diferencial
---

## Introducción 

## Instalar y cargas paquetes

```{r message=FALSE, warning=FALSE}

# Cargar el paquete de R que incluye a SummarizedExperiment y todas las demás dependencias
library("recount3")
library("limma")
library("edgeR")

```


## Selección de Proyecto

```{r}

# Obtener la lista de proyectos disponibles 
human_projects <- available_projects()

# Ver los proyectos disponibles
dim(human_projects)


# Mostrar las primeras filas para inspeccionar su estructura y contenido
head(human_projects)

# Seleccionar un estudio de interés
human_projects[709, ]

# Filtrar el dataframe para seleccionar un proyecto específico basado en su ID y tipo
project_info <- subset(
  human_projects,
  project == "SRP075398" & project_type == "data_sources"
)

# Mostrar la información del proyecto seleccionado para confirmar que se ha filtrado correctamente
project_info

```

```{r}

# Crear un objeto de tipo RangedSummarizedExperiment (RSE) con la información a nivel de genes
rse_gene_SRP075398 <- create_rse(project_info)

# Explorar el objeto RSE
rse_gene_SRP075398

## Información sobre el RSE creado
metadata(rse_gene_SRP075398)

## Número de genes y número de muestras
dim(rse_gene_SRP075398)

```

El estudio **SRP068565** se compuso de **20 muestras**, para las cuales tenemos **63,856 genes** en GENCODE v26.
La información específica de la anotación está disponible rowRanges() como se muestra a continuación con la columna gene_id utilizada para identificar genes en cada una de las anotaciones.

```{r}

# Información sobre los genes
rowRanges(rse_gene_SRP075398)
```


## Preparación de los datos 

```{r}

# Convertir las cuentas por nucleotido a cuentas por lectura usando compute_read_counts().
assay(rse_gene_SRP075398, "counts") <- compute_read_counts(rse_gene_SRP075398)

rse_gene_SRP075398$sra.sample_attributes[]

# Hacer más fácil de usar la información del experimento
rse_gene_SRP075398 <- expand_sra_attributes(rse_gene_SRP075398)

colData(rse_gene_SRP075398)[
  ,
  grepl("^sra_attribute", colnames(colData(rse_gene_SRP075398)))
]


colnames(colData(rse_gene_SRP075398))

```

```{r}

# Ajustar el tipo de dato de las variables
## Pasar de character a factor

rse_gene_SRP075398$sra_attribute.cell_line <- factor(rse_gene_SRP075398$sra_attribute.cell_line)

rse_gene_SRP075398$sra_attribute.source_name <- factor(tolower(rse_gene_SRP075398$sra_attribute.source_name))

rse_gene_SRP075398$sra_attribute.transfection <- factor(rse_gene_SRP075398$sra_attribute.transfection)

# Resumen de las variables
summary(as.data.frame(colData(rse_gene_SRP075398)[
    ,
    grepl("^sra_attribute.[cell_line|source_name|transfection]", colnames(colData(rse_gene_SRP075398)))
]))

```

```{r}
# Calcular la proporción de lecturas asignadas a genes
rse_gene_SRP075398$assigned_gene_prop <- 
  rse_gene_SRP075398$recount_qc.gene_fc_count_all.assigned / 
  rse_gene_SRP075398$recount_qc.gene_fc_count_all.total

# Resumen de la nueva variable
summary(rse_gene_SRP075398$assigned_gene_prop)


```

## Filtrar genes de baja expresión

```{r}
# Guardar el objeto original
rse_gene_SRP075398_unfiltered <- rse_gene_SRP075398

# Filtrar muestras de baja calidad
hist(rse_gene_SRP075398$assigned_gene_prop)
table(rse_gene_SRP075398$assigned_gene_prop < 0.3)
rse_gene_SRP075398 <- rse_gene_SRP075398[, rse_gene_SRP075398$assigned_gene_prop > 0.3]

# Filtrar genes de baja expresión usando edgeR
dge <- DGEList(counts = assay(rse_gene_SRP075398, "counts"))
keep <- filterByExpr(dge, group = rse_gene_SRP075398$sra_attribute.transfection)
rse_gene_SRP075398 <- rse_gene_SRP075398[keep, ]

# Dimensiones finales
dim(rse_gene_SRP075398)

# Porcentaje de genes retenidos
round(nrow(rse_gene_SRP075398) / nrow(rse_gene_SRP075398_unfiltered) * 100, 2)

```


## Normalización de los datos

```{r}
# Crear un objeto DGEList para normalización
dge <- DGEList(
    counts = assay(rse_gene_SRP075398, "counts"),
    genes = rowData(rse_gene_SRP075398)
)

# Normalización TMM
dge <- calcNormFactors(dge)

dge
```


## Determinar el modelo estadístico

```{r}

mod <- model.matrix(
  ~ sra_attribute.cell_line * sra_attribute.transfection,
  data = colData(rse_gene_SRP075398)
)

colnames(mod)

# Simplificar nombres de la columna

#colnames(mod) <- c("Intercept", "CellLine_MCF7", "Transfection_miR29a", 
                   #"Transfection_miR29b1", "Interaction_MCF7_miR29a", 
                   #"Interaction_MCF7_miR29b1")
```

# Visualizar matriz (REVISAR ESTO AL FINAL)

```{r}
library(ExploreModelMatrix)

## Crear las visualizaciones
vd <- ExploreModelMatrix::VisualizeDesign(
    sampleData = colData(rse_gene_SRP075398), # Metadatos de las muestras
    designFormula = ~ sra_attribute.cell_line * sra_attribute.transfection,           # Fórmula del modelo
    textSizeFitted = 1                       # Tamaño del texto
)

library(cowplot)
cowplot::plot_grid(plotlist = vd$plotlist)

```


# Expresión diferencial

```{r}
vGene <- voom(dge, mod, plot = TRUE)

# Ajuste del modelo lineal y cálculo de estadísticas empíricas de Bayes
eb_results <- eBayes(lmFit(vGene))

de_results <- topTable(
    eb_results,
    coef = 2,
    number = nrow(rse_gene_SRP075398),
    sort.by = "none"
)

# Dimensiones y vista preliminar de los resultados
dim(de_results)
head(de_results)

```
```{r}

## Genes diferencialmente expresados con FDR < 5%
table(de_results$adj.P.Val < 0.05)

## Visualizar los resultados estadísticos

plotMA(eb_results, coef = 2)

volcanoplot(eb_results, coef = 2, highlight = 3, names = de_results$gene_name)

## Información de los 3 genes más significativos 
de_results[de_results$gene_name %in% c("AMIGO2", "APBB2", "LGALS3"), ]

```

# Visualizar genes DE

```{r}

# Revisar los top 50 genes diferencialmente expresados

## Extraer valores de los genes de interés
exprs_heatmap <- vGene$E[rank(de_results$adj.P.Val) <= 50, ]

## Creemos una tabla con información de las muestras
## y con nombres de columnas más amigables
df <- as.data.frame(colData(rse_gene_SRP075398)[, c("sra_attribute.cell_line", "sra_attribute.transfection")])
colnames(df) <- c("Cell_line", "Transfection")

## Hagamos un heatmap
library("pheatmap")
pheatmap(
    exprs_heatmap,
    cluster_rows = TRUE,
    cluster_cols = TRUE,
    show_rownames = FALSE,
    show_colnames = FALSE,
    annotation_col = df
)
```

```{r}
# MDS (multidimensional scaling)

## Para colores
library("RColorBrewer")

## Conviertiendo los grupos de Cell_line a colores
col.group <- df$Cell_line
levels(col.group) <- brewer.pal(nlevels(col.group), "Set1")
col.group <- as.character(col.group)

## MDS por grupos de Cell_line
plotMDS(vGene$E, labels = df$Cell_line, col = col.group)
```


```{r}
## Para colores
library("RColorBrewer")

## Convertir Transfection a colores
col.group <- df$Transfection
df$Transfection <- as.factor(df$Transfection) # Asegúrate de que sea un factor
colors <- brewer.pal(nlevels(df$Transfection), "Set1") # Generar paleta de colores
levels(col.group) <- colors # Asignar colores a los niveles
col.group <- as.character(col.group) # Convertir a vector de caracteres

## MDS por grupos de Transfection
plotMDS(vGene$E, labels = df$Transfection, col = col.group, 
        main = "MDS Plot by Transfection", pch = 16)

## Agregar leyenda
legend("topright", legend = levels(df$Transfection), fill = unique(col.group),
       title = "Transfection Groups")
```










